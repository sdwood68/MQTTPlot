<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>MQTTPlot</title>

    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <link rel="stylesheet" href="/static/mqttplot.css">
    <script type="module" src="/static/js/common_main.js"></script>
    {% if admin %}
    <script type="module" src="/static/js/admin_main.js"></script>
    {% endif %}
</head>

<body class="{{ 'admin' if admin else '' }}" data-admin="{{ 'true' if admin else 'false' }}">

  <div id="top-bar">
      <div id="mqtt-status" class="mqtt-status mqtt-status--unknown">
        MQTT: (checking…)
      </div>

      <div id="admin-bar">
        {% if admin %}
        <span>Admin: {{ admin_user }}</span>
        <a href="/admin/logout">Logout</a>
        {% else %}
        <a href="{{ url_for('admin_login_page') }}">Admin Login</a>
        {% endif %}
      </div>
    </div>

    <h2>MQTTPlot</h2>
    <p><b>Broker:</b> {{ broker }}</p>

    {% if admin %}
    <div class="admin-box">
        <b>Admin Mode Enabled</b>
    </div>
    {% endif %}

    {% if admin %}
      <h3>Topics</h3>
      <div id="topics"></div>

      <h3>Plot Data</h3>
      <label>Topic:
          <input id="topicInput" list="topiclist">
      </label>
      <!-- Start time remains optional for manual entry -->
      <label>From:
          <input id="start" placeholder="ISO time or epoch (optional)">
      </label>

      <!-- End time is no longer user-controlled; keep hidden for internal windowing -->
      <input id="end" type="hidden" value="">

      <button id="btnPlot">Plot</button>

      <!-- v0.6.0 plot window controls -->
      <div style="margin-top: 8px;">
          <button id="btnBack">◀ Back 50%</button>
          <button id="btnFwd">Forward 50% ▶</button>
          <button id="btnZoomIn">Zoom In</button>
          <button id="btnZoomOut">Zoom Out</button>
      </div>

      <datalist id="topiclist"></datalist>
      <div id="plot"></div>
    {% else %}
      <h3>Published Plots</h3>
      {% if public_plots and public_plots|length > 0 %}
        <ul>
          {% for p in public_plots %}
            <li><a href="/p/{{ p.slug }}">{{ p.title or p.slug }}</a></li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No published plots are currently available.</p>
      {% endif %}
    {% endif %}

    {% if admin %}
      <div class="admin-box">
          <h3>OTA Control</h3>
          <input id="otaBase" placeholder="Base topic (e.g. watergauge)">
          <button id="btnOtaEnter">Enter OTA</button>
          <button id="btnOtaExit">Exit OTA</button>
      </div>
    {% endif %}

    {% if admin %}
    <hr>
    <div class="admin-box">
        <h3>Retention Policies (per Top-Level Topic)</h3>
        <p>
            Set <code>max_age_days</code> and/or <code>max_rows</code>. Leave blank to disable that limit.
        </p>
        <div>
            <label>Top-level topic:
                <input id="ret_top_level" placeholder="e.g. watergauge">
            </label>
            <label>Max age (days):
                <input id="ret_max_age_days" type="number" min="1">
            </label>
            <label>Max rows:
                <input id="ret_max_rows" type="number" min="1">
            </label>
            <button id="btnSaveRetention">Save retention</button>
        </div>
        <pre id="retention_status"></pre>
        <hr>
    </div>
    {% endif %}

    {% if admin %}
    <hr>
    <div class="admin-box">
        <h3>Public Plot URLs</h3>
        <p>
          Create a published plot and share the URL <code>/p/&lt;slug&gt;</code>.
          Only published plots are visible to non-admin users.
        </p>
        <div>
          <label>Slug:
            <input id="pp_slug" placeholder="e.g. watergauge-temps">
          </label>
          <label>Title:
            <input id="pp_title" placeholder="Display title (optional)">
          </label>
        </div>
        <div style="margin-top:6px;">
          <label>Topics (comma-separated):
            <input id="pp_topics" placeholder="/watergauge/temp1,/watergauge/temp2" style="width: 520px;">
          </label>
        </div>
        <div style="margin-top:6px;">
          <label>Default range (seconds):
            <input id="pp_range_sec" type="number" min="60" value="3600">
          </label>
          <label style="margin-left:10px;">
            <input id="pp_published" type="checkbox" checked> Published
          </label>
          <button id="btnSavePublicPlot" style="margin-left:10px;">Save</button>
          <button id="btnRefreshPublicPlots">Refresh list</button>
        </div>
        <pre id="public_plots_status"></pre>
        <div id="public_plots_list"></div>
    </div>
    {% endif %}
</body>

</html>